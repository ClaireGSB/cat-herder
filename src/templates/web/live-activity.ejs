<%- include('partials/header', { title: 'Live Activity' }) %>

<% if (runningTask) { %>
    <!-- Context Header -->
    <div class="card bg-light border-0 mb-3">
        <div class="card-body">
            <% if (parentSequence) { %>
                <h6 class="card-subtitle mb-2 text-muted">
                    <i class="bi bi-collection me-1"></i>
                    SEQUENCE: <%= parentSequence.sequenceId %> (<%= parentSequence.phase %>)
                </h6>
            <% } %>
            <h5 class="card-title mb-1">
                <i class="bi bi-gear-fill me-1"></i>
                TASK: <%= runningTask.taskId %>
            </h5>
            <p class="card-text text-primary mb-0">
                <strong>
                    <i class="bi bi-arrow-repeat spinner-border spinner-border-sm me-1" role="status"></i>
                    RUNNING STEP: <span id="running-step-name"><%= runningTask.currentStep %></span>
                </strong>
            </p>
        </div>
    </div>
<% } else { %>
    <!-- No Running Task View -->
    <div class="empty-state">
        <div class="text-center">
            <i class="bi bi-moon-stars display-1 text-muted mb-3"></i>
            <h3 class="text-muted mb-3">No Task is Currently Running</h3>
            
            <% if (lastFinishedTask) { %>
                <p class="text-muted">The last task to run has completed.</p>
                <div class="card d-inline-block p-3 bg-light" style="max-width: 600px; text-align: left;">
                    <h6 class="mb-1">Last Activity:</h6>
                    <p class="mb-1">
                        <strong>Task ID:</strong> <%= lastFinishedTask.taskId %>
                    </p>
                    <p class="mb-2">
                        <strong>Status:</strong> 
                        <span class="badge status-<%= lastFinishedTask.phase %>"><%= lastFinishedTask.phase %></span>
                    </p>
                    <a href="/task/<%= lastFinishedTask.taskId %>" class="btn btn-sm btn-outline-secondary">
                        View Details
                    </a>
                </div>
            <% } else { %>
                <p class="text-muted mb-4">
                    When a task starts, its live logs will appear here automatically.
                </p>
            <% } %>
        </div>
    </div>
<% } %>

<!-- Log Viewer -->
<div class="log-viewer">
    <pre id="live-log-content" class="log-content"><% if (!runningTask) { %>Waiting for a task to start...<% } %></pre>
</div>

<!-- Pass data to the client-side script -->
<script>
    // 1. Render the server-side data into a JavaScript string literal.
    // The linter sees a valid string assignment, and the EJS tag is safely inside the quotes.
    const runningTaskJSON = '<%- JSON.stringify(runningTask || null) %>';
    const lastFinishedTaskJSON = '<%- JSON.stringify(lastFinishedTask || null) %>';

    // 2. Safely parse the JSON string into a JavaScript object.
    const runningTaskObject = JSON.parse(runningTaskJSON);
    const lastFinishedTaskObject = JSON.parse(lastFinishedTaskJSON);

    // 3. Assign it to the global object. This is clean and error-free.
    window.liveActivityData = {
        runningTask: runningTaskObject,
        lastFinishedTask: lastFinishedTaskObject
    };
</script>

<%- include('partials/footer') %>