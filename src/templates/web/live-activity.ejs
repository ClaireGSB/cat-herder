<%- include('partials/header', { title: 'Live Activity', page: 'live-activity' }) %>

<div class="row">
    <!-- =============================================================== -->
    <!-- === CONTEXT SIDEBAR (Stacks on mobile) === -->
    <!-- =============================================================== -->
    <div class="col-lg-4 order-lg-1">
        <% if (taskToShow) { %>
            <!-- Sequence Context Panel -->
            <% if (parentSequence) { %>
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-collection me-2"></i>Sequence Tasks</h6>
                    </div>
                    <ul class="list-group list-group-flush">
                        <% parentSequence.tasks.forEach(task => { %>
                            <li class="list-group-item d-flex justify-content-between align-items-center <%= task.taskId === taskToShow.taskId ? 'active' : '' %>">
                                <span><i class="bi bi-file-earmark-text me-2"></i><%= task.filename %></span>
                                <span class="badge status-<%= task.status %>"><%= task.status %></span>
                            </li>
                        <% }); %>
                    </ul>
                </div>
            <% } %>

            <!-- Current Task Steps Panel -->
            <div class="card">
                <div class="card-header">
                     <h6 class="mb-0"><i class="bi bi-list-ol me-2"></i>Task Steps</h6>
                </div>
                <ul class="list-group list-group-flush">
                     <% if (taskToShow.steps && Object.keys(taskToShow.steps).length > 0) { %>
                        <% Object.entries(taskToShow.steps).forEach(([stepName, stepStatus]) => { %>
                            <li class="list-group-item d-flex justify-content-between align-items-center <%= stepName === taskToShow.currentStep ? 'active' : '' %>">
                                <span><%= stepName %></span>
                                <span class="badge status-<%= stepStatus %>">
                                     <% if (stepStatus === 'running') { %>
                                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                     <% } %>
                                    <%= stepStatus %>
                                </span>
                            </li>
                        <% }); %>
                    <% } else { %>
                         <li class="list-group-item text-muted">Steps not yet started.</li>
                    <% } %>
                </ul>
            </div>
        <% } %>
    </div>

    <!-- =============================================================== -->
    <!-- === MAIN CONTENT AREA === -->
    <!-- =============================================================== -->
    <div class="col-lg-8 order-lg-2">
        <% if (taskToShow) { %>
            <!-- Context Header -->
            <div class="card bg-light border-0 mb-3">
                <div class="card-body">
                    <% if (isLive) { %>
                        <p class="card-text text-primary mb-0">
                            <strong>
                                <i class="bi bi-arrow-repeat spinner-border spinner-border-sm me-1" role="status"></i>
                                RUNNING STEP: <span id="running-step-name"><%= taskToShow.currentStep %></span>
                            </strong>
                        </p>
                    <% } else { %>
                         <p class="card-text text-muted mb-0">
                            <strong>
                                No task running. Showing last activity.
                            </strong>
                        </p>
                    <% } %>
                    <h5 class="card-title mt-2 mb-1">
                        <i class="bi bi-gear-fill me-1"></i>
                        TASK: <span id="running-task-id"><%= taskToShow.taskId %></span>
                    </h5>
                     <% if (parentSequence) { %>
                        <h6 class="card-subtitle mb-2 text-muted">
                            <i class="bi bi-collection me-1"></i>
                            SEQUENCE: <%= parentSequence.sequenceId %> <span class="badge status-<%= parentSequence.phase %>"><%= parentSequence.phase %></span>
                        </h6>
                    <% } %>
                </div>
            </div>
        <% } else { %>
            <!-- No Task Ever Run View -->
            <div class="empty-state card">
                 <div class="card-body">
                    <div class="text-center">
                        <i class="bi bi-moon-stars display-1 text-muted mb-3"></i>
                        <h3 class="text-muted mb-3">No Task is Currently Running</h3>
                        <p class="text-muted mb-4">
                            When a task starts, its live logs and status will appear here.
                        </p>
                    </div>
                 </div>
            </div>
        <% } %>

        <!-- Log Viewer -->
        <div class="log-viewer mt-3">
            <pre id="live-log-content" class="log-content"><% 
                if (initialLogContent) {
                    // We just print the raw text content here. The script below will colorize it.
                    %><%- initialLogContent %><%
                } else if (isLive) {
                    %>Connecting to live log stream...<%
                } else if (taskToShow) {
                    %>Log for last step not available.<%
                } else {
                    %>Waiting for a task to start...<%
                }
            %></pre>
        </div>
    </div>
</div>


<!-- Pass data to the client-side script -->
<script>
    const taskToShowJSON = '<%- JSON.stringify(taskToShow || null) %>';
    const parentSequenceJSON = '<%- JSON.stringify(parentSequence || null) %>';
    
    // Unify the data for dashboard.js
    window.liveActivityData = {
        runningTask: JSON.parse(taskToShowJSON), // dashboard.js expects 'runningTask'
        lastFinishedTask: null, // No longer needed
        parentSequence: JSON.parse(parentSequenceJSON),
        isLive: <%- isLive %>
    };

    // Client-side script to colorize the pre-loaded log
    document.addEventListener('DOMContentLoaded', () => {
        const logContainer = document.getElementById('live-log-content');
        const initialContent = `<%- JSON.stringify(initialLogContent || null) %>`;

        if (logContainer && initialContent && initialContent !== 'null') {
            const parsedContent = JSON.parse(initialContent);
            if (window.dashboard && typeof window.dashboard.colorizeLogLine === 'function') {
                const lines = parsedContent.split('\\n'); // Note the escaped newline
                logContainer.innerHTML = lines.map(line => window.dashboard.colorizeLogLine(line)).join('');
            }
        }
    });
</script>

<%- include('partials/footer', { page: 'live-activity' }) %>