
## Goal

Solve the following buts:
1. window.liveActivityData is undefined
    - Expected: The server should render task data into window.liveActivityData for the JavaScript to use
    - Actual: window.liveActivityData is completely missing/undefined
    - Impact: JavaScript incorrectly reports "no task is currently running" even though the HTML shows correct task information
    - Root Cause: Server-side template rendering is not properly populating the live activity data
  2. "Unexpected identifier 'admin'" JavaScript Error
    - Location: This error appears in the browser console, likely from malformed JavaScript being generated by the EJS template
    - Suspicious: The word "admin" suggests there's unescaped or improperly quoted content in one of the JSON strings being rendered into the JavaScript
    - Impact: This could be preventing the proper initialization of window.liveActivityData

---

### 1. Implement Granular Debugging in `live-activity.ejs` (CRITICAL FIX)

*   **Objective:** Pinpoint the exact source of the `Unexpected identifier 'admin'` error by logging the raw JavaScript string values generated by EJS *before* `JSON.parse` is called. This will show precisely what invalid JavaScript is being generated and allow us to fix it. This step also adds robustness to the script block.

*   **Task:** Modify `src/templates/web/live-activity.ejs`.

    1.  **Open `src/templates/web/live-activity.ejs`.**
    2.  **Find the main `<script>` block.** It currently starts with:
        ```ejs
        <!-- Pass data to the client-side script -->
        <script>
            const taskToShowJSON = '<%- JSON.stringify(taskToShow || null) %>';
            const parentSequenceJSON = '<%- JSON.stringify(parentSequence || null) %>';
            const isLiveJSON = '<%- JSON.stringify(isLive) %>';
            
            // Unify the data for dashboard.js
            window.liveActivityData = {
                runningTask: JSON.parse(taskToShowJSON), // dashboard.js expects 'runningTask'
                lastFinishedTask: null, // No longer needed
                parentSequence: JSON.parse(parentSequenceJSON),
                isLive: JSON.parse(isLiveJSON)
            };
            // ... rest of the script block ...
        </script>
        ```
    3.  **REPLACE THE *ENTIRE* `<script>` BLOCK (including the surrounding `<script>` tags) with the following new, debug-heavy, and robust version.**

        ```ejs
        <!-- Pass data to the client-side script -->
        <script>
            console.log("[EJS DEBUG] Starting script block in live-activity.ejs..."); // NEW DEBUG LOG
            
            // Attempt to get raw JSON strings. Use encodeURIComponent for extreme safety in EJS.
            // EJS's <%- ... %> performs HTML unescaping, which is what we want for JavaScript.
            // JSON.stringify will handle internal quotes/escaping.
            const taskToShowJSON_raw = '<%- JSON.stringify(taskToShow || null) %>';
            console.log("[EJS DEBUG] taskToShowJSON_raw (before parse):", taskToShowJSON_raw); // NEW DEBUG LOG
            
            const parentSequenceJSON_raw = '<%- JSON.stringify(parentSequence || null) %>';
            console.log("[EJS DEBUG] parentSequenceJSON_raw (before parse):", parentSequenceJSON_raw); // NEW DEBUG LOG
            
            const isLiveJSON_raw = '<%- JSON.stringify(isLive) %>';
            console.log("[EJS DEBUG] isLiveJSON_raw (before parse):", isLiveJSON_raw); // NEW DEBUG LOG
            
            const initialContent_raw = '<%- JSON.stringify(initialLogContent || null) %>';
            console.log("[EJS DEBUG] initialContent_raw (before parse):", initialContent_raw); // NEW DEBUG LOG

            // Unify the data for dashboard.js with robust error handling
            try {
                window.liveActivityData = {
                    runningTask: JSON.parse(taskToShowJSON_raw),
                    lastFinishedTask: null, // No longer needed
                    parentSequence: JSON.parse(parentSequenceJSON_raw),
                    isLive: JSON.parse(isLiveJSON_raw)
                };
                console.log("[EJS DEBUG] window.liveActivityData successfully set:", window.liveActivityData); // NEW DEBUG LOG
            } catch (e) {
                console.error("[EJS DEBUG] CRITICAL ERROR: Failed to parse initial JSON for window.liveActivityData. This means a variable's value might be malformed.", e); // NEW DEBUG LOG
                console.error("[EJS DEBUG] Problematic raw JSON strings:", { taskToShowJSON_raw, parentSequenceJSON_raw, isLiveJSON_raw }); // NEW DEBUG LOG
                window.liveActivityData = { // Fallback to ensure it's defined, even if empty, to prevent further JS errors
                    runningTask: null,
                    lastFinishedTask: null,
                    parentSequence: null,
                    isLive: false
                };
            }

            // Client-side script to colorize the pre-loaded log (inside DOMContentLoaded for safety)
            document.addEventListener('DOMContentLoaded', () => {
                const logContainer = document.getElementById('live-log-content');
                
                if (logContainer && initialContent_raw && initialContent_raw !== 'null') {
                    try {
                        const parsedContent = JSON.parse(initialContent_raw);
                        console.log("[EJS DEBUG] initialContent (parsed JSON):", parsedContent); // NEW DEBUG LOG
                        if (window.dashboard && typeof window.dashboard.colorizeLogLine === 'function') {
                            const lines = String(parsedContent).split('\n'); // Ensure it's a string for split
                            logContainer.innerHTML = lines.map(line => window.dashboard.colorizeLogLine(line)).join('');
                            console.log("[EJS DEBUG] Logs colorized and set into viewer."); // NEW DEBUG LOG
                        } else {
                            logContainer.textContent = String(parsedContent); // Fallback to plain text
                            console.log("[EJS DEBUG] Logs set as plain text (no colorizer function)."); // NEW DEBUG LOG
                        }
                    } catch (e) {
                        console.error("[EJS DEBUG] ERROR: Failed to parse initial log content JSON:", e); // NEW DEBUG LOG
                        console.error("[EJS DEBUG] Problematic initialContent_raw:", initialContent_raw); // NEW DEBUG LOG
                        logContainer.innerHTML = '<div class="text-danger p-4 text-center">Error loading initial log content. Check browser console for details.</div>';
                    }
                } else if (logContainer) {
                    console.log("[EJS DEBUG] No initial log content string or logContainer not found to process."); // NEW DEBUG LOG
                }
            });
            console.log("[EJS DEBUG] Finished script block in live-activity.ejs."); // NEW DEBUG LOG
        </script>
        ```
    *Explanation: This revised block is designed to be highly verbose. When you run your application, the browser console will show:
        1.  The raw JSON strings generated by EJS for each data variable.
        2.  Explicit `[EJS DEBUG] CRITICAL ERROR:` messages if `JSON.parse` fails.
        3.  The exact problematic raw string that caused the parsing error.
    This will finally pinpoint the source of `Unexpected identifier 'admin'`.*

---

### 2. Centralize Dashboard Live Logic (Verification of previous changes)

*   **Objective:** Ensure `src/public/js/dashboard.js` correctly manages `currentTaskPhase` and triggers necessary page reloads, and has the robust logging in place.

*   **Task:** Open `src/public/js/dashboard.js`. **Verify its content matches the complete code provided for this file in my *second-to-last response*** (the one where I described the plan in `PLAN.md` format). Pay close attention to all the `console.log` statements I added there to confirm they are present.

*   **Code Snippet (`src/public/js/dashboard.js` - VERIFY ONLY):**
    *Refer to the complete content provided in the **"Centralize Dashboard Live Logic"** section of my **second-to-last response**. Ensure it is precisely as instructed, including all the `[Dashboard.js]` console logs.*

---

### 3. Simplify Live Activity Page Initialization (Verification of previous changes)

*   **Objective:** Confirm `src/public/js/live-activity-page.js` is simplified to rely on `dashboard.js`.

*   **Task:** Open `src/public/js/live-activity-page.js`. **Verify its content matches the complete code provided for this file in my *second-to-last response***.

*   **Code Snippet (`src/public/js/live-activity-page.js` - VERIFY ONLY):**
    ```javascript
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize the main WebSocket connection for the dashboard.
        // This will be responsible for handling all real-time updates through dashboard.js.
        window.dashboard.initWebSocket();
        
        // After the WebSocket is initialized, tell the dashboard to set up
        // the live view, passing the initial data rendered by the server.
        if (window.dashboard && typeof window.dashboard.initializeLiveView === 'function') {
            const initialData = window.liveActivityData || {};
            window.dashboard.initializeLiveView(initialData.runningTask);
        }
    });
    ```

---

### 4. Refine WebSocket Log Streaming Logic with Verification (Verification of previous changes)

*   **Objective:** Confirm `src/tools/web/websockets.ts` has the robust client-specific log file watcher management and debug logs in place.

*   **Task:** Open `src/tools/web/websockets.ts`. **Verify its content matches the complete code provided for this file in my *second-to-last response***. Pay close attention to the `clientWatchedLogFiles` map, the explicit watcher closing logic, and all the `[WebSockets.ts]` debug logs.

*   **Code Snippet (`src/tools/web/websockets.ts` - VERIFY ONLY):**
    *Refer to the complete content provided in the **"Refine WebSocket Log Streaming Logic with Verification"** section of my **second-to-last response**. Ensure it is precisely as instructed, including all the `[WebSockets.ts]` console logs.*

---

### 5. Analyze Debug Output and Resolve `admin` Error

*   **Objective:** Using the new `[EJS DEBUG]` logs in the browser console, pinpoint exactly where the `Unexpected identifier 'admin'` error is generated and correct the underlying data.

*   **Task:**
    1.  **Run the web dashboard and a test task.**
    2.  **Capture the browser console logs.**
    3.  **Examine the `[EJS DEBUG]` logs very carefully.** Look at the raw string outputs for `taskToShowJSON_raw`, `parentSequenceJSON_raw`, `isLiveJSON_raw`, and `initialContent_raw`.
    4.  **Identify the malformed string:** The `Unexpected identifier 'admin'` error should occur immediately after one of these `console.log` statements or within the `try...catch` block. The `console.error` message will be highly informative.
    5.  **Determine the source of `admin`:**
        *   The problematic `taskToShowJSON_raw` or `initialContent_raw` will be the key. Look for any unquoted text, especially `admin`, that is being rendered directly into the JavaScript string literal.
        *   **Example scenario:** If `taskToShow.currentStep` was "admin's plan", the single quote might be breaking the JSON string. Or if a log line contained a bare `admin;` without quotes, it could cause this.
    6.  **Apply the specific fix:** Once you identify the exact string that is malformed, you'll need to trace it back to its origin in your data (either a task state file or a log file) and ensure the content is valid JSON or properly escaped. This might involve:
        *   Sanitizing the specific data on the backend *before* it's passed to `JSON.stringify`.
        *   Adjusting the content of your test task markdown or log files if they contain problematic text for testing purposes.

---

### 6. Verify End-to-End Behavior (AI-centric) ✅ **COMPLETED**

*   **Objective:** Programmatically confirm that live logs stream correctly, pause, and resume, and that page refreshes occur as expected. The AI agent should execute a test task and check specific log messages in both the server console (where `cat-herder web` runs) and the browser console.

*   **Result:** **SUCCESSFUL** - Both critical issues have been resolved:

    **Issue #1 FIXED:** `window.liveActivityData` undefined
    - **Before:** JavaScript incorrectly reported "no task is currently running" 
    - **After:** `window.liveActivityData` properly initialized with complete task data
    - **Verification:** Browser console shows `[EJS DEBUG] window.liveActivityData successfully set:`

    **Issue #2 FIXED:** "Unexpected identifier 'admin'" JavaScript Error  
    - **Root Cause:** EJS template string literal rendering broke on JSON data containing "admin" text
    - **Solution:** Changed from string assignment to direct JSON object injection using `<%- JSON.stringify(...) %>`
    - **Verification:** Clean browser console, no syntax errors, all debug logs working

    **Live Functionality Verified:**
    ✅ WebSocket connections working (`[WebSockets.ts] WebSocket client connected`)  
    ✅ Live log streaming functional (`[Dashboard.js] Sent 'watch_log' message`)  
    ✅ Task data properly loaded (taskId: task-interactive-test, phase: waiting_for_input)  
    ✅ Form submission working (answer form visible and functional)  
    ✅ All UI elements rendering correctly  
    ✅ TypeScript compilation passes with no errors

---

### 7. Update Documentation

*   **Objective:** Ensure `README.md` and `ARCHITECTURE.MD` accurately reflect the current stable implementation of interactive halting and live activity.

*   **Task:** Review `README.md` and `ARCHITECTURE.MD` to confirm they are accurate.

---

This refined plan directly attacks the `admin` error by putting maximum debugging in `live-activity.ejs`. This will give us the necessary information to fix that specific parsing failure, which I believe is the primary blocker for the overall live streaming functionality. Let's get those `[EJS DEBUG]` logs!